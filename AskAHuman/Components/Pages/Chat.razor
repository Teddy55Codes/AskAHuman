@using AskAHuman.Services.Interfaces
@using DataBaseLayer.DTOs
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject IChatService ChatService
@inject IAuthenticationService AuthenticationService
@inject IMessageService MessageService
@inject ILiveMessageService LiveMessageService
@inject ProtectedSessionStorage ProtectedSessionStore
@implements IDisposable

@page "/Chats/{chatId:long}"

<MudText Class="ml-2" Color="@Color.Error" hidden="@(!isNotFound)" >Chat does not exist.</MudText>

<MudGrid Class="mt-1" hidden="@isNotFound">
    <MudItem xs="12">
        <MudCard Elevation="2" Class="pa-2">
            <h1 Class="mx-3 my-6">@chat.Title</h1>
            <MudText Class="ma-6 flex-wrap">@chat.Question</MudText>
        </MudCard>
    </MudItem>
    <MudItem xs="12">
        @foreach (var message in messages)
        {
            <MudCard Class="pa-1 my-2" Elevation="2">
                <h3 Class="mx-3 mb-6 mt-3">@message.AuthorName</h3>
                <MudText Class="mx-3 my-3">@message.Message</MudText>
            </MudCard>
        }
    </MudItem>
    <MudItem xs="12" Elevation="2">
        <MudCard hidden="@(!isAuthenticated)">
            <EditForm Model="@model" OnValidSubmit="SendChatMessage">
            <DataAnnotationsValidator/>
                <MudGrid Class="align-center">
                    <MudItem xs="11">
                        <MudCardContent>
                            <MudTextField Label="Message" Variant="Variant.Outlined" @bind-Value="model.message" For="@(() => model.message)"/>
                        </MudCardContent>
                    </MudItem>
                    <MudItem xs="1">
                        <MudCardActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Send" Color="Color.Primary" ButtonType="ButtonType.Submit"/>
                        </MudCardActions>
                    </MudItem>
                </MudGrid>
            </EditForm>
        </MudCard>
    </MudItem>
</MudGrid>



@code {
    [Parameter]
    public long ChatId { get; set; }
    
    public TextMessage model = new();

    private bool isNotFound;
    private bool isAuthenticated;
    private long userId;
    private string currentMessage;

    private DatabaseLayer.Entities.Chat? chat;
    private List<MessageDTO> messages;

    public class TextMessage
    {
        public string message { get; set; }
    }
    
    private void SendChatMessage()
    {
        if (string.IsNullOrEmpty(model.message)) return;
        LiveMessageService.SendMessageToChat(model.message, userId);
        model = new();
    }

    protected override async Task OnInitializedAsync()
    {

        chat = ChatService.GetChatById(ChatId);
        if (chat is null)
        {
            isNotFound = true;
            return;
        }
        messages = MessageService.GetMessagesForChatById(ChatId);   

        try
        {
            var uId = await CheckAuthentication();
            if (uId is not null)
            {
                isAuthenticated = true;
                userId = (long)uId;
            }

            LiveMessageService.SetInformation(ChatId, userId);
            LiveMessageService.OnMessageReceived += MessageReceived;
        }
        catch (InvalidOperationException) { }
    }

    private void MessageReceived(MessageDTO message)
    {
        messages.Add(message);
        InvokeAsync(StateHasChanged);
    }
    
    private async Task<long?> CheckAuthentication()
    {
        var jwt = await ProtectedSessionStore.GetAsync<string>("Jwt");
        if (jwt.Success)
        {
            var result = AuthenticationService.ValidateJWT(jwt.Value!);
            if (result.IsSuccess)
            {
                return long.Parse(result.Value.Claims.First(c => c.Type == "userId").Value);
            }
        }

        return null;
    }

    public void Dispose()
    {
        if (LiveMessageService is IDisposable disposable) disposable.Dispose();
    }
}